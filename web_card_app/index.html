<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debit Card Generator</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">
    <!-- Stripe.js Script -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --primary: #D4AF37;
            --primary-dark: #B4941F;
            --bg: #000000;
            --surface: #111111;
            --text: #E0E0E0;
            --text-light: #A0A0A0;
            --border: #333333;
            --success: #10b981;
            --danger: #ef4444;
            --input-bg: #1a1a1a;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 900px;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.15);
            overflow: hidden;
            border: 1px solid #333;
        }

        .header {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color: var(--primary);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--primary);
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header .signature {
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: 0.7rem;
            font-weight: 400;
            opacity: 0.8;
            letter-spacing: 0.5px;
            color: var(--text-light);
        }

        .lang-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px;
            background: #111;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            text-align: center;
            text-align-last: center;
            min-width: 100px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: #0a0a0a;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #1a1a1a;
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: linear-gradient(to top, rgba(212, 175, 55, 0.1), transparent);
        }

        .tab-content {
            display: none;
            padding: 20px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--text);
            outline: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }

        input[type="checkbox"] {
            accent-color: var(--primary);
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
            vertical-align: middle;
        }

        button.action-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 700;
            transition: transform 0.1s, box-shadow 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button.action-btn:hover {
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            transform: translateY(-1px);
        }

        button.action-btn:active {
            transform: translateY(1px);
        }

        .output-area {
            background: #000;
            color: var(--primary);
            padding: 15px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid var(--border);
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #222;
            padding-bottom: 2px;
        }

        .status-led {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #333;
            /* Default gray/off */
            margin-left: 10px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .status-led.active {
            background-color: var(--success);
            box-shadow: 0 0 8px var(--success);
        }

        .status-led.error {
            background-color: var(--danger);
            box-shadow: 0 0 8px var(--danger);
        }

        .card-brand-icon {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--text-light);
        }

        .card-brand-icon.visa {
            color: #4287f5;
        }

        .card-brand-icon.mastercard {
            color: #eb001b;
        }

        .card-brand-icon.amex {
            color: #007bc1;
        }

        .card-brand-icon.discover {
            color: #f9a021;
        }

        .log-live {
            color: #4ade80;
            font-weight: bold;
        }

        .log-die {
            color: #f87171;
        }

        .luhn-badge {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(16, 185, 129, 0.3);
            margin-left: 4ch;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            white-space: nowrap;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: start;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #1a1a1a;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Input with Icon Styling */
        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-right: 50px;
            /* Space for icon in LTR */
        }

        .input-with-icon .card-brand-icon {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            margin: 0;
            pointer-events: none;
        }

        /* RTL Support */
        [dir="rtl"] .status-led {
            margin-left: 0;
            margin-right: 10px;
        }

        [dir="rtl"] .input-with-icon input {
            padding-right: 10px;
            /* Reset LTR padding */
            padding-left: 50px;
            /* Space for icon in RTL */
        }

        [dir="rtl"] .input-with-icon .card-brand-icon {
            right: auto;
            left: 15px;
            margin: 0;
        }

        [dir="rtl"] .luhn-badge {
            margin-left: 0;
            margin-right: 4ch;
        }

        [dir="rtl"] input[type="checkbox"] {
            margin-right: 0;
            margin-left: 12px;
        }

        [dir="rtl"] .lang-selector {
            right: auto;
            left: 20px;
        }

        [dir="rtl"] .header .signature {
            right: auto;
            left: 15px;
        }

        [dir="rtl"] .tab-btn {
            font-family: 'Segoe UI', sans-serif;
            /* Better Arabic font fallback */
        }

        /* Custom Dropdown Styling */
        .custom-select-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 100px;
            /* Reduced width */
            z-index: 100;
            font-size: 0.8rem;
            /* Reduced font size */
            user-select: none;
        }

        [dir="rtl"] .custom-select-container {
            right: auto;
            left: 20px;
        }

        .custom-select-trigger {
            background: #111;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            /* Slightly smaller radius */
            padding: 6px 10px;
            /* Reduced padding */
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .custom-select-trigger:hover {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
        }

        .custom-options {
            position: absolute;
            top: 115%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid var(--border);
            border-radius: 10px;
            /* Match trigger radius */
            overflow: hidden;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 101;
            flex-direction: column;
        }

        .custom-options.open {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .custom-option {
            padding: 8px 10px;
            /* Reduced padding */
            cursor: pointer;
            transition: background 0.2s;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .custom-option:last-child {
            border-bottom: none;
        }

        .custom-option:hover {
            background: var(--input-bg);
            color: var(--primary);
        }

        .custom-option.selected {
            background: rgba(212, 175, 55, 0.15);
            color: var(--primary);
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="header">
            <h1 data-i18n="title">Debit Card Generator</h1>
            <div class="signature" data-i18n="signature">By DRDXB</div>

            <!-- Custom Language Dropdown -->
            <div class="custom-select-container" id="langSelectorContainer">
                <div class="custom-select-trigger" onclick="toggleLangDropdown()">
                    <span id="currentLangText">English</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">▼</span>
                </div>
                <div class="custom-options" id="langOptions">
                    <div class="custom-option" onclick="selectLanguage('en', 'English')">English</div>
                    <div class="custom-option" onclick="selectLanguage('ar', 'العربية')">العربية</div>
                    <div class="custom-option" onclick="selectLanguage('zh', '中文')">中文</div>
                    <div class="custom-option" onclick="selectLanguage('tr', 'Türkçe')">Türkçe</div>
                    <div class="custom-option" onclick="selectLanguage('ru', 'Русский')">Русский</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('tab1')" data-i18n="tab_gen">Generation</button>
            <button class="tab-btn" onclick="switchTab('tab2')" data-i18n="tab_active">Active Cards</button>
            <button class="tab-btn" onclick="switchTab('tab3')" data-i18n="tab_check">Checker</button>
            <button class="tab-btn" onclick="switchTab('tab5')" data-i18n="tab_admin">Admin</button>
            <button class="tab-btn" onclick="switchTab('tab4')" data-i18n="tab_settings">Settings</button>
        </div>

        <!-- Tab 1: Generation -->
        <div id="tab1" class="tab-content active">
            <div class="form-group">
                <label data-i18n="label_bin">BIN / Prefix (6-15 digits)</label>
                <div class="input-with-icon">
                    <input type="text" id="binInput" value="424242" placeholder="0000 0000 0000 0000"
                        data-i18n-placeholder="placeholder_bin" oninput="handleBinInput(this)">
                    <span id="brandIcon" class="card-brand-icon"></span>
                </div>
            </div>

            <!-- BIN Details Box -->
            <div id="binDetails"
                style="margin-bottom: 20px; padding: 15px; background: #1a1a1a; border: 1px solid var(--border); border-radius: 6px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: var(--primary); font-weight: bold; font-size: 0.9em;">CARD INFO</span>
                    <span id="binCountryFlag" style="font-size: 1.5em;"></span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                    <div>
                        <span style="color: var(--text-light);">Bank:</span> <br>
                        <span id="binBank" style="color: #fff;">-</span>
                    </div>
                    <div>
                        <span style="color: var(--text-light);">Country:</span> <br>
                        <span id="binCountry" style="color: #fff;">-</span>
                    </div>
                    <div>
                        <span style="color: var(--text-light);">Type:</span> <br>
                        <span id="binType" style="color: #fff;">-</span>
                    </div>
                    <div>
                        <span style="color: var(--text-light);">Level:</span> <br>
                        <span id="binLevel" style="color: #fff;">-</span>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <div class="form-group" style="flex: 1;">
                    <label data-i18n="label_month">Month (MM)</label>
                    <select id="monthInput">
                        <option value="rnd" data-i18n="val_random">Random</option>
                        <option value="01">01</option>
                        <option value="02">02</option>
                        <option value="03">03</option>
                        <option value="04">04</option>
                        <option value="05">05</option>
                        <option value="06">06</option>
                        <option value="07">07</option>
                        <option value="08">08</option>
                        <option value="09">09</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label data-i18n="label_year">Year (YY)</label>
                    <select id="yearInput">
                        <option value="rnd" data-i18n="val_random">Random</option>
                        <option value="26">2026</option>
                        <option value="27">2027</option>
                        <option value="28">2028</option>
                        <option value="29">2029</option>
                        <option value="30">2030</option>
                        <option value="31">2031</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label data-i18n="label_cvv">CVV (Optional)</label>
                    <input type="text" id="cvvInput" placeholder="Random if empty"
                        data-i18n-placeholder="placeholder_cvv" maxlength="4">
                </div>
            </div>

            <div class="form-group">
                <label data-i18n="label_qty">Quantity</label>
                <input type="number" id="qtyInput" value="10">
            </div>
            <button class="action-btn" onclick="generateCards()" data-i18n="btn_generate">Generate Cards</button>

            <div id="selectionControls"
                style="display: none; margin-top: 15px; gap: 10px; align-items: center; background: #111; padding: 10px; border-radius: 6px; border: 1px solid #333;">
                <label style="margin:0; display:flex; align-items:center; cursor:pointer; color: var(--text);">
                    <input type="checkbox" id="selectAllBox" onchange="toggleSelectAll()"> <span
                        data-i18n="checkbox_select_all">Select All</span>
                </label>
                <button class="action-btn" style="width: auto; padding: 8px 15px; font-size: 0.9rem; margin-left: auto;"
                    onclick="sendSelectedToChecker()" data-i18n="btn_send_check">
                    Send to Checker ➔
                </button>
            </div>

            <div id="genOutputFormatted" class="output-area" style="white-space: normal;"></div>
        </div>

        <!-- Tab 2: Active Cards Simulation -->
        <div id="tab2" class="tab-content">
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" style="flex:1" onclick="loadActiveCards()" data-i18n="btn_refresh">Refresh
                    List</button>
                <button class="action-btn" style="flex:1; background: #333; color: white;" onclick="copyActiveCards()"
                    data-i18n="btn_copy">Copy</button>
                <button class="action-btn" style="flex:1; background: #333; color: white;"
                    onclick="downloadActiveCards()" data-i18n="btn_download">Download .txt</button>
            </div>
            <table id="activeTable">
                <thead>
                    <tr>
                        <th data-i18n="th_card">Card Number</th>
                        <th data-i18n="th_exp">Expiry</th>
                        <th data-i18n="th_cvv">CVV</th>
                        <th data-i18n="th_status">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here -->
                </tbody>
            </table>
        </div>

        <!-- Tab 3: Checker (Real Stripe API) -->
        <div id="tab3" class="tab-content">
            <div class="form-group">
                <label data-i18n="label_sk_active">Stripe Secret Key (Active Configuration)</label>
                <input type="text" value="Not Configured" readonly
                    style="background: #f1f5f9; color: #64748b; font-weight: bold;">
            </div>
            <div class="form-group">
                <label data-i18n="label_input_list">Input List (Card|Exp|CVV)</label>
                <textarea id="checkInput" rows="5" placeholder="Paste your list here..."
                    data-i18n-placeholder="placeholder_list"></textarea>
            </div>

            <div
                style="background: #111; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #333;">
                <label style="color: var(--primary); display:block; margin-bottom:10px;">Bulk Operations</label>
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label style="font-size: 0.8em; color: var(--text-light);">Price ID (Optional - for
                            Subscription)</label>
                        <input type="text" id="priceIdInput" placeholder="price_123..." style="font-family: monospace;">
                    </div>
                    <button class="action-btn" style="flex: 1;" onclick="startChecker()" data-i18n="btn_start_check">
                        Start Check (Auth Only)
                    </button>
                    <button class="action-btn"
                        style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"
                        onclick="startSubscriptionCheck()">
                        Create Customer & Subscribe
                    </button>
                </div>
            </div>

            <hr style="border-color: #333; margin: 20px 0;">

            <!-- Stripe Elements Section -->
            <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 1px solid #333;">
                <h3 style="margin-top:0; color: var(--primary);">Single Card Check (Stripe Elements)</h3>
                <p style="font-size: 0.9em; color: var(--text-light);">
                    Enter card details directly into Stripe's secure iframe. This simulates a real checkout flow using
                    <b>SetupIntents</b>.
                </p>

                <div class="form-group">
                    <label>Card Details</label>
                    <div id="stripe-card-element" style="background: white; padding: 12px; border-radius: 6px;">
                        <!-- Stripe Element will be inserted here -->
                    </div>
                    <div id="card-errors" role="alert" style="color: var(--danger); margin-top: 8px; font-size: 0.9em;">
                    </div>
                </div>

                <button id="btn-verify-element" class="action-btn" onclick="verifyWithStripeElement()">
                    Verify via Stripe Elements
                </button>
                <div id="element-result" style="margin-top: 15px; font-weight: bold;"></div>
            </div>

            <div id="checkLog" class="output-area"></div>
        </div>

        <!-- Tab 4: Settings -->
        <div id="tab4" class="tab-content">
            <div
                style="background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--primary);">
                <h3 style="margin-top:0; color: var(--primary);" data-i18n="header_config">Configuration</h3>
                <p style="margin-bottom:0; color: var(--text-light); font-size: 0.9rem;" data-i18n="text_config_desc">
                    Manage your API keys and
                    account settings here. These are saved locally.</p>
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="label_sk">Stripe Secret Key (sk_live_...)</span>
                    <span id="led-stripe" class="status-led" title="Unknown Status"></span>
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="skInput" placeholder="sk_live_..."
                        style="font-family: monospace; flex: 1;">
                    <button class="action-btn" style="width: auto; padding: 10px;" onclick="verifyStripeKey()"
                        data-i18n="btn_check_key">Check</button>
                </div>
            </div>

            <!-- Publishable Key Input (For Elements) -->
            <div class="form-group">
                <label>
                    <span>Stripe Publishable Key (pk_live_...)</span>
                    <span id="led-stripe-pk" class="status-led" title="Unknown Status"></span>
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="pkInput" placeholder="pk_live_..."
                        style="font-family: monospace; flex: 1;">
                    <button class="action-btn" style="width: auto; padding: 10px;" onclick="verifyPublishableKey()">Check</button>
                </div>
                <small style="color: #666;">Required for the 'Checker' tab (Stripe Elements).</small>
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="label_pk">Stripe Publishable Key (pk_live_...)</span>
                    <span id="led-stripe-pk" class="status-led" title="Unknown Status"></span>
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="pkInput" placeholder="pk_live_..."
                        style="font-family: monospace; flex: 1;">
                    <button class="action-btn" style="width: auto; padding: 10px;" onclick="verifyPublishableKey()"
                        data-i18n="btn_check_key">Check</button>
                </div>
            </div>

            <hr style="border-color: #333; margin: 20px 0;">

            <div class="form-group">
                <label>
                    <span data-i18n="label_paypal">PayPal API (Client ID:Secret)</span>
                    <span id="led-paypal" class="status-led" title="Unknown Status"></span>
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="paypalInput" placeholder="client_id:secret"
                        style="font-family: monospace; flex: 1;">
                    <button class="action-btn" style="width: auto; padding: 10px;" onclick="verifyGenericKey('paypal')"
                        data-i18n="btn_check_key">Check</button>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <span data-i18n="label_mastercard">MasterCard API Key</span>
                    <span id="led-mastercard" class="status-led" title="Unknown Status"></span>
                </label>
                <div style="display: flex; gap: 10px;">
                    <input type="password" id="mastercardInput" placeholder="MasterCard API Key"
                        style="font-family: monospace; flex: 1;">
                    <button class="action-btn" style="width: auto; padding: 10px;"
                        onclick="verifyGenericKey('mastercard')" data-i18n="btn_check_key">Check</button>
                </div>
            </div>

            <div class="form-group">
                <label data-i18n="label_accounts">Accounts / Proxies List (Optional)</label>
                <textarea id="accountsInput" rows="5" placeholder="Format: user:pass@ip:port or specific account IDs..."
                    data-i18n-placeholder="placeholder_accounts"></textarea>
            </div>

            <button class="action-btn" onclick="saveSettings()" data-i18n="btn_save">Save Configuration</button>
            <p id="saveMsg" style="text-align: center; margin-top: 10px; font-weight: 600; min-height: 24px;"></p>
        </div>

        <!-- Tab 5: Admin Dashboard -->
        <div id="tab5" class="tab-content">
            <h2 style="color: var(--primary); margin-top: 0;">Admin Dashboard</h2>
            
            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex: 1; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center;">
                    <div style="color: var(--text-light); font-size: 0.9em;">Total Transactions</div>
                    <div id="statsTotal" style="font-size: 2em; font-weight: bold; color: white;">0</div>
                </div>
                <div style="flex: 1; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center;">
                    <div style="color: var(--text-light); font-size: 0.9em;">Success Rate</div>
                    <div id="statsSuccessRate" style="font-size: 2em; font-weight: bold; color: var(--success);">0%</div>
                </div>
                <div style="flex: 1; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; text-align: center;">
                    <div style="color: var(--text-light); font-size: 0.9em;">Revenue (Est.)</div>
                    <div id="statsRevenue" style="font-size: 2em; font-weight: bold; color: var(--primary);">$0</div>
                </div>
            </div>

            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: white;">Recent Transactions</h3>
                    <button onclick="loadAdminStats()" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                        <thead>
                            <tr style="border-bottom: 1px solid #333; text-align: left;">
                                <th style="padding: 10px; color: var(--text-light);">Time</th>
                                <th style="padding: 10px; color: var(--text-light);">Type</th>
                                <th style="padding: 10px; color: var(--text-light);">Card / Customer</th>
                                <th style="padding: 10px; color: var(--text-light);">Status</th>
                            </tr>
                        </thead>
                        <tbody id="adminTxTable">
                            <tr><td colspan="4" style="padding: 20px; text-align: center; color: #666;">No transactions yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === Logic: Internationalization (i18n) ===
        const translations = {
            en: {
                title: "Debit Card Generator",
                signature: "By DRDXB",
                tab_gen: "Generation",
                tab_active: "Active Cards",
                tab_check: "Checker",
                tab_admin: "Admin",
                tab_settings: "Settings",
                label_bin: "BIN / Prefix (6-15 digits)",
                placeholder_bin: "0000 0000 0000 0000",
                label_month: "Month (MM)",
                label_year: "Year (YY)",
                label_cvv: "CVV (Optional)",
                placeholder_cvv: "Random if empty",
                label_qty: "Quantity",
                btn_generate: "Generate Cards",
                checkbox_select_all: "Select All",
                btn_send_check: "Send to Checker",
                btn_load_active: "Load Active Cards (API Mock)",
                th_card: "Card Number",
                th_exp: "Expiry",
                th_cvv: "CVV",
                th_status: "Status",
                label_sk_active: "Stripe Secret Key (Active Configuration)",
                label_input_list: "Input List (Card|Exp|CVV)",
                placeholder_list: "Paste your list here...",
                btn_start_check: "Start Live Stripe Check",
                header_config: "Configuration",
                text_config_desc: "Manage your API keys and account settings here. These are saved locally.",
                label_sk: "Stripe Secret Key (sk_live_...)",
                label_pk: "Stripe Publishable Key (pk_live_...)",
                label_accounts: "Accounts / Proxies List (Optional)",
                placeholder_accounts: "Format: user:pass@ip:port or specific account IDs...",
                btn_save: "Save Configuration",
                msg_saved: "Settings Saved Successfully!",
                val_random: "Random",
                msg_no_active: "No verified active cards yet. Run the Checker to find live cards.",
                luhn_passed: "Luhn Check Passed",
                msg_invalid_bin: "Please enter a valid BIN/Prefix (6-15 digits).",
                msg_select_card: "Please select at least one card to send to Checker.",
                label_paypal: "PayPal API",
                label_mastercard: "MasterCard API",
                btn_check_key: "Check",
                btn_refresh: "Refresh List",
                btn_copy: "Copy",
                btn_download: "Download .txt",
                msg_copied: "Copied to clipboard!",
                msg_downloaded: "List downloaded."
            },
            ar: {
                title: "مولد بطاقات الخصم",
                signature: "بواسطة DRDXB",
                tab_gen: "توليد",
                tab_active: "البطاقات النشطة",
                tab_check: "الفاحص",
                tab_settings: "الإعدادات",
                label_bin: "BIN / البادئة (6-15 رقم)",
                placeholder_bin: "0000 0000 0000 0000",
                label_month: "الشهر (MM)",
                label_year: "السنة (YY)",
                label_cvv: "CVV (اختياري)",
                placeholder_cvv: "عشوائي إذا فارغ",
                label_qty: "الكمية",
                btn_generate: "توليد البطاقات",
                checkbox_select_all: "تحديد الكل",
                btn_send_check: "إرسال للفحص",
                btn_load_active: "تحميل البطاقات النشطة",
                th_card: "رقم البطاقة",
                th_exp: "الانتهاء",
                th_cvv: "CVV",
                th_status: "الحالة",
                label_sk_active: "مفتاح Stripe السري (التكوين النشط)",
                label_input_list: "قائمة الإدخال (Card|Exp|CVV)",
                placeholder_list: "الصق قائمتك هنا...",
                btn_start_check: "بدء فحص Stripe المباشر",
                header_config: "التكوين",
                text_config_desc: "أدر مفاتيح API وإعدادات الحساب هنا. يتم حفظها محلياً.",
                label_sk: "مفتاح Stripe السري (sk_live_...)",
                label_pk: "مفتاح Stripe العام (pk_live_...)",
                label_accounts: "قائمة الحسابات / البروكسي (اختياري)",
                placeholder_accounts: "التنسيق: user:pass@ip:port أو معرفات حساب محددة...",
                btn_save: "حفظ الإعدادات",
                msg_saved: "تم حفظ الإعدادات بنجاح!",
                val_random: "عشوائي",
                msg_no_active: "لا توجد بطاقات نشطة مؤكدة بعد. شغل الفاحص للعثور على بطاقات حية.",
                luhn_passed: "اجتاز فحص Luhn",
                msg_invalid_bin: "الرجاء إدخال BIN/بادئة صحيحة (6-15 رقم).",
                msg_select_card: "الرجاء تحديد بطاقة واحدة على الأقل للإرسال للفحص.",
                label_paypal: "PayPal API",
                label_mastercard: "MasterCard API",
                btn_check_key: "فحص",
                btn_refresh: "تحديث القائمة",
                btn_copy: "نسخ",
                btn_download: "تحميل .txt",
                msg_copied: "تم النسخ للحافظة!",
                msg_downloaded: "تم تحميل القائمة."
            },
            zh: {
                title: "借记卡生成器",
                signature: "由 DRDXB 开发",
                tab_gen: "生成",
                tab_active: "活跃卡片",
                tab_check: "检查器",
                tab_settings: "设置",
                label_bin: "BIN / 前几位 (6-12位)",
                placeholder_bin: "0000 0000 0000 0000",
                label_month: "月份 (MM)",
                label_year: "年份 (YY)",
                label_cvv: "CVV (可选)",
                placeholder_cvv: "留空则随机",
                label_qty: "数量",
                btn_generate: "生成卡片",
                checkbox_select_all: "全选",
                btn_send_check: "发送到检查器",
                btn_load_active: "加载活跃卡片",
                th_card: "卡号",
                th_exp: "过期",
                th_cvv: "CVV",
                th_status: "状态",
                label_sk_active: "Stripe 密钥 (当前配置)",
                label_input_list: "输入列表 (Card|Exp|CVV)",
                placeholder_list: "在此粘贴列表...",
                btn_start_check: "开始实时 Stripe 检查",
                header_config: "配置",
                text_config_desc: "在此管理您的 API 密钥和帐户设置。这些设置保存在本地。",
                label_sk: "Stripe 密钥 (sk_live_...)",
                label_pk: "Stripe 公钥 (pk_live_...)",
                label_accounts: "帐户 / 代理列表 (可选)",
                placeholder_accounts: "格式: user:pass@ip:port 或特定帐户 ID...",
                btn_save: "保存配置",
                msg_saved: "设置保存成功！",
                val_random: "随机",
                msg_no_active: "尚无验证的活跃卡片。运行检查器以查找有效卡片。",
                luhn_passed: "Luhn 校验通过",
                msg_invalid_bin: "请输入有效的 BIN (6-12位数字)。",
                msg_select_card: "请至少选择一张卡片发送到检查器。",
                btn_refresh: "刷新列表",
                btn_copy: "复制",
                btn_download: "下载 .txt",
                msg_copied: "已复制到剪贴板！",
                msg_downloaded: "列表已下载。"
            },
            tr: {
                title: "Banka Kartı Oluşturucu",
                signature: "DRDXB Tarafından",
                tab_gen: "Oluşturma",
                tab_active: "Aktif Kartlar",
                tab_check: "Kontrolcü",
                tab_settings: "Ayarlar",
                label_bin: "BIN / İlk Rakamlar (6-12 hane)",
                placeholder_bin: "0000 0000 0000 0000",
                label_month: "Ay (AA)",
                label_year: "Yıl (YY)",
                label_cvv: "CVV (İsteğe bağlı)",
                placeholder_cvv: "Boşsa rastgele",
                label_qty: "Miktar",
                btn_generate: "Kart Oluştur",
                checkbox_select_all: "Hepsini Seç",
                btn_send_check: "Kontrolcüye Gönder",
                btn_load_active: "Aktif Kartları Yükle",
                th_card: "Kart Numarası",
                th_exp: "Son Kullanma",
                th_cvv: "CVV",
                th_status: "Durum",
                label_sk_active: "Stripe Gizli Anahtarı (Aktif Yapılandırma)",
                label_input_list: "Giriş Listesi (Card|Exp|CVV)",
                placeholder_list: "Listenizi buraya yapıştırın...",
                btn_start_check: "Canlı Stripe Kontrolünü Başlat",
                header_config: "Yapılandırma",
                text_config_desc: "API anahtarlarınızı ve hesap ayarlarınızı buradan yönetin. Bunlar yerel olarak kaydedilir.",
                label_sk: "Stripe Gizli Anahtarı (sk_live_...)",
                label_pk: "Stripe Yayınlanabilir Anahtarı (pk_live_...)",
                label_accounts: "Hesaplar / Proxy Listesi (İsteğe bağlı)",
                placeholder_accounts: "Format: user:pass@ip:port veya belirli hesap ID'leri...",
                btn_save: "Yapılandırmayı Kaydet",
                msg_saved: "Ayarlar Başarıyla Kaydedildi!",
                val_random: "Rastgele",
                msg_no_active: "Henüz doğrulanmış aktif kart yok. Canlı kartları bulmak için Kontrolcüyü çalıştırın.",
                luhn_passed: "Luhn Kontrolü Başarılı",
                msg_invalid_bin: "Lütfen geçerli bir BIN girin (6-12 hane).",
                msg_select_card: "Lütfen kontrolcüye göndermek için en az bir kart seçin.",
                btn_refresh: "Listeyi Yenile",
                btn_copy: "Kopyala",
                btn_download: "İndir .txt",
                msg_copied: "Pano kopyalandı!",
                msg_downloaded: "Liste indirildi."
            },
            ru: {
                title: "Генератор Дебетовых Карт",
                signature: "От DRDXB",
                tab_gen: "Генерация",
                tab_active: "Активные Карты",
                tab_check: "Проверка",
                tab_settings: "Настройки",
                label_bin: "BIN / Первые Цифры (6-12 цифр)",
                placeholder_bin: "0000 0000 0000 0000",
                label_month: "Месяц (MM)",
                label_year: "Год (YY)",
                label_cvv: "CVV (Необязательно)",
                placeholder_cvv: "Случайно, если пусто",
                label_qty: "Количество",
                btn_generate: "Создать Карты",
                checkbox_select_all: "Выбрать Все",
                btn_send_check: "Отправить на Проверку",
                btn_load_active: "Загрузить Активные Карты",
                th_card: "Номер Карты",
                th_exp: "Срок",
                th_cvv: "CVV",
                th_status: "Статус",
                label_sk_active: "Секретный Ключ Stripe (Активная Конфигурация)",
                label_input_list: "Список Ввода (Card|Exp|CVV)",
                placeholder_list: "Вставьте ваш список сюда...",
                btn_start_check: "Запустить Живую Проверку Stripe",
                header_config: "Конфигурация",
                text_config_desc: "Управляйте ключами API и настройками аккаунта здесь. Они сохраняются локально.",
                label_sk: "Секретный Ключ Stripe (sk_live_...)",
                label_pk: "Публичный Ключ Stripe (pk_live_...)",
                label_accounts: "Список Аккаунтов / Прокси (Необязательно)",
                placeholder_accounts: "Формат: user:pass@ip:port или конкретные ID аккаунтов...",
                btn_save: "Сохранить Конфигурацию",
                msg_saved: "Настройки Успешно Сохранены!",
                val_random: "Случайно",
                msg_no_active: "Пока нет подтвержденных активных карт. Запустите Проверку, чтобы найти живые карты.",
                luhn_passed: "Проверка Luhn Пройдена",
                btn_refresh: "Обновить Список",
                btn_copy: "Копировать",
                btn_download: "Скачать .txt",
                msg_copied: "Скопировано в буфер обмена!",
                msg_downloaded: "Список скачан."
            }
        };

        let currentLang = 'en';
        const langNames = {
            'en': 'English',
            'ar': 'العربية',
            'zh': '中文',
            'tr': 'Türkçe',
            'ru': 'Русский'
        };

        function toggleLangDropdown() {
            document.getElementById('langOptions').classList.toggle('open');
        }

        function selectLanguage(lang, name) {
            document.getElementById('currentLangText').innerText = name;
            document.getElementById('langOptions').classList.remove('open');
            changeLanguage(lang);

            // Highlight selected
            document.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
            // Find option with text == name and add selected
            // Or better logic:
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function (e) {
            const container = document.getElementById('langSelectorContainer');
            if (!container.contains(e.target)) {
                document.getElementById('langOptions').classList.remove('open');
            }
        });

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('syriaPay_lang', lang);

            // Update Dropdown Text if called externally or on load
            if (langNames[lang]) {
                document.getElementById('currentLangText').innerText = langNames[lang];
            }

            // RTL support for Arabic
            if (lang === 'ar') {
                document.body.setAttribute('dir', 'rtl');
            } else {
                document.body.setAttribute('dir', 'ltr');
            }

            // Update Text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });

            // Update Placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
        }

        // === Logic: Tab Switching ===
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            // Find button that calls this tab and activate it
            const buttons = document.querySelectorAll('.tab-btn');
            // Reset all first
            buttons.forEach(b => b.classList.remove('active'));

            if (tabId === 'tab1') buttons[0].classList.add('active');
            if (tabId === 'tab2') buttons[1].classList.add('active');
            if (tabId === 'tab3') buttons[2].classList.add('active');
            if (tabId === 'tab5') buttons[3].classList.add('active'); // Admin
            if (tabId === 'tab4') buttons[4].classList.add('active'); // Settings

            // Load Admin Stats if Tab 5
            if (tabId === 'tab5' && typeof loadAdminStats === 'function') {
                loadAdminStats();
            }
        }

        // === Logic: Settings Management ===
        function saveSettings() {
            const sk = document.getElementById('skInput').value.trim();
            const pk = document.getElementById('pkInput').value.trim();
            const paypal = document.getElementById('paypalInput').value.trim();
            const mastercard = document.getElementById('mastercardInput').value.trim();
            const acc = document.getElementById('accountsInput').value;

            localStorage.setItem('syriaPay_sk', sk);
            localStorage.setItem('syriaPay_pk', pk);
            localStorage.setItem('syriaPay_paypal', paypal);
            localStorage.setItem('syriaPay_mastercard', mastercard);
            localStorage.setItem('syriaPay_acc', acc);

            const msg = document.getElementById('saveMsg');
            msg.innerText = translations[currentLang].msg_saved;
            msg.style.color = "var(--success)";
            setTimeout(() => { msg.innerText = ""; }, 3000);

            updateCheckerUI();
        }

        function loadSettings() {
            const sk = localStorage.getItem('syriaPay_sk') || "";
            // Default PK
            const pk = localStorage.getItem('syriaPay_pk') || "";
            const paypal = localStorage.getItem('syriaPay_paypal') || "";
            const mastercard = localStorage.getItem('syriaPay_mastercard') || "";
            const acc = localStorage.getItem('syriaPay_acc') || "";

            document.getElementById('skInput').value = sk;
            document.getElementById('pkInput').value = pk;
            document.getElementById('paypalInput').value = paypal;
            document.getElementById('mastercardInput').value = mastercard;
            document.getElementById('accountsInput').value = acc;

            updateCheckerUI();
        }

        function updateCheckerUI() {
            const sk = localStorage.getItem('syriaPay_sk');
            const displayField = document.querySelector('#tab3 input[readonly]');
            if (sk) {
                displayField.value = sk.substring(0, 15) + "..." + sk.substring(sk.length - 4);
                displayField.style.color = "var(--primary)";
                displayField.style.fontWeight = "bold";
            } else {
                displayField.value = "Not Configured";
                displayField.style.color = "#64748b";
                displayField.style.fontWeight = "normal";
            }
        }

        // Initialize Settings on Load
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            // Trigger brand detection on load
            const binInput = document.getElementById('binInput');
            handleBinInput(binInput); // Format initial value
        });

        // === Logic: Brand Detection & API Verification ===
        let binLookupTimeout;

        function handleBinInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits

            // Limit to 16 digits
            if (value.length > 16) value = value.slice(0, 16);

            // Format with spaces
            let formatted = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formatted += ' ';
                formatted += value[i];
            }

            // Only update if changed to avoid cursor jumping issues (basic implementation)
            if (input.value !== formatted) {
                input.value = formatted;
            }

            detectBrand(value);

            // BIN Lookup Trigger
            clearTimeout(binLookupTimeout);
            if (value.length >= 6) {
                binLookupTimeout = setTimeout(() => {
                    fetchBinDetails(value.substring(0, 8)); // Use first 6-8 digits
                }, 500); // 500ms debounce
            } else {
                document.getElementById('binDetails').style.display = 'none';
            }
        }

        async function fetchBinDetails(bin) {
            const detailsBox = document.getElementById('binDetails');
            const bankEl = document.getElementById('binBank');
            const countryEl = document.getElementById('binCountry');
            const typeEl = document.getElementById('binType');
            const levelEl = document.getElementById('binLevel');
            const flagEl = document.getElementById('binCountryFlag');

            try {
                // Show loading state
                detailsBox.style.display = 'block';
                bankEl.innerText = 'Loading...';
                countryEl.innerText = '...';
                flagEl.innerText = '';
                typeEl.innerText = '...';
                levelEl.innerText = '...';

                console.log('Fetching BIN details for:', bin);

                // Always use explicit URL with port
                const apiUrl = `http://localhost:8081/api/lookup/${bin}`;
                console.log('API URL:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('BIN API Response:', result);

                if (result.success && result.found && result.data) {
                    const data = result.data;
                    console.log('Card data received:', data);

                    // Display the data
                    bankEl.innerText = data.bank?.name || data.bank || 'Card Issuer';
                    countryEl.innerText = data.country?.name || data.country || 'Unknown';
                    flagEl.innerText = data.country?.emoji || '🌍';
                    typeEl.innerText = (data.scheme || 'VISA') + ' ' + (data.type || 'Debit');
                    levelEl.innerText = data.brand || 'CARD';

                    console.log('✓ Card info displayed successfully');
                } else {
                    console.log('No data in response, showing defaults');
                    bankEl.innerText = 'Card Issuer';
                    countryEl.innerText = 'Unknown';
                    flagEl.innerText = '🌍';
                    typeEl.innerText = 'Debit Card';
                    levelEl.innerText = 'CARD';
                }
            } catch (error) {
                console.error('✗ BIN Lookup Error:', error.message);
                console.error('Stack:', error.stack);

                const detailsBox = document.getElementById('binDetails');
                detailsBox.style.display = 'block';
                document.getElementById('binBank').innerText = 'Card Issuer';
                document.getElementById('binCountry').innerText = 'Unknown';
                document.getElementById('binCountryFlag').innerText = '🌍';
                document.getElementById('binType').innerText = 'Debit Card';
                document.getElementById('binLevel').innerText = 'CARD';

                // Log for debugging
                console.error('Showing fallback data due to error');
            }
        }

        function detectBrand(bin) {
            const iconSpan = document.getElementById('brandIcon');
            iconSpan.className = 'card-brand-icon'; // Reset
            iconSpan.innerHTML = '';

            if (!bin || bin.length < 1) return;

            const firstDigit = bin.charAt(0);
            if (firstDigit === '4') {
                iconSpan.classList.add('visa');
                iconSpan.innerHTML = 'VISA';
            } else if (firstDigit === '5') {
                iconSpan.classList.add('mastercard');
                iconSpan.innerHTML = 'MASTERCARD';
            } else if (firstDigit === '3') {
                iconSpan.classList.add('amex');
                iconSpan.innerHTML = 'AMEX';
            } else if (firstDigit === '6') {
                iconSpan.classList.add('discover');
                iconSpan.innerHTML = 'DISCOVER';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.innerText = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '12px 24px';
            toast.style.borderRadius = '8px';
            toast.style.color = '#fff';
            toast.style.fontWeight = '600';
            toast.style.zIndex = '10000';
            toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
            toast.style.transition = 'opacity 0.3s ease';

            if (type === 'success') {
                toast.style.backgroundColor = 'var(--success)';
            } else if (type === 'error') {
                toast.style.backgroundColor = 'var(--danger)';
            } else {
                toast.style.backgroundColor = 'var(--primary)';
                toast.style.color = '#000';
            }

            document.body.appendChild(toast);

            // Trigger reflow for transition
            void toast.offsetWidth;
            toast.style.opacity = '1';

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        async function verifyPublishableKey() {
            const pk = document.getElementById('pkInput').value.trim();
            const led = document.getElementById('led-stripe-pk');

            if (pk.startsWith('sk_')) {
                showToast('Error: You entered a Secret Key (sk_...) here. Please use the field above.', 'error');
                led.className = 'status-led error';
                return;
            }

            if (!pk.startsWith('pk_live_') && !pk.startsWith('pk_test_')) {
                showToast('Invalid Key Format (must start with pk_live_ or pk_test_)', 'error');
                led.className = 'status-led error';
                return;
            }

            led.className = 'status-led loading';

            try {
                // Try to create a token with dummy data to test the key
                // Using fetch directly to Stripe API
                const body = new URLSearchParams();
                body.append('card[number]', '4242424242424242');
                body.append('card[exp_month]', '12');
                body.append('card[exp_year]', '2030');
                body.append('card[cvc]', '123');

                const response = await fetch('https://api.stripe.com/v1/tokens', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Basic ' + btoa(pk + ':'),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body
                });

                const data = await response.json();

                if (response.ok) {
                    // Token created successfully -> Live
                    showToast('Key is Live & Valid!', 'success');
                    led.className = 'status-led active';
                    localStorage.setItem('syriaPay_pk', pk);
                } else {
                    // Check error type
                    // If error is "card_declined" (402), the key IS VALID because it reached the bank/processor
                    // If error is "invalid_request_error" (401) or "Invalid API Key", it is INVALID

                    if (data.error && data.error.code === 'card_declined') {
                        showToast('Key is Live! (Card Declined)', 'success');
                        led.className = 'status-led active';
                        localStorage.setItem('syriaPay_pk', pk);
                    } else if (response.status === 401 || (data.error && data.error.message.includes('Invalid API Key'))) {
                        showToast('Invalid API Key', 'error');
                        led.className = 'status-led error';
                    } else {
                        // Other errors usually mean the key is working but parameters are wrong
                        // e.g. "parameter_missing"
                        showToast('Key is Valid (Error: ' + data.error.message + ')', 'success');
                        led.className = 'status-led active';
                        localStorage.setItem('syriaPay_pk', pk);
                    }
                }

            } catch (error) {
                console.error(error);
                showToast('Connection Error', 'error');
                led.className = 'status-led error';
            }
        }

        async function verifyPublishableKey() {
            const pk = document.getElementById('pkInput').value.trim();
            const led = document.getElementById('led-stripe-pk');

            if (!pk.startsWith('pk_')) {
                led.className = 'status-led error';
                led.title = 'Invalid Format';
                showToast('Invalid Key Format (must start with pk_)', 'error');
                return;
            }

            try {
                // Initialize Stripe to check validity
                const stripeTest = Stripe(pk);
                // Try a lightweight call
                localStorage.setItem('syriaPay_pk', pk);
                led.className = 'status-led active';
                showToast('Publishable Key Saved!', 'success');
            } catch (e) {
                led.className = 'status-led error';
                showToast("Invalid Publishable Key", 'error');
            }
        }

        async function verifyStripeKey() {
            const sk = document.getElementById('skInput').value.trim();
            const led = document.getElementById('led-stripe');

            // --- FIX FOR USER CONFUSION (PK vs SK) ---
            // If user enters a Publishable Key (pk_...) into the Secret Key field,
            // we should explain it clearly OR auto-save it to the right place.
            if (sk.startsWith('pk_')) {
                // Auto-save as Publishable Key if valid format
                localStorage.setItem('syriaPay_pk', sk);
                showToast('Info: You entered a Publishable Key (pk_...). Saved as Client Key.', 'success');
                
                // Clear the input to avoid confusion, or leave it and warn? 
                // Let's warn them to enter the SK for full features.
                led.className = 'status-led error';
                led.title = 'This is a Publishable Key (pk_), not Secret Key (sk_)';
                showToast('Note: This key is for the frontend (saved). Please enter Secret Key (sk_) for backend.', 'warning');
                return;
            }

            if (!sk.startsWith('sk_')) {
                led.className = 'status-led error';
                led.title = 'Invalid Format';
                showToast('Invalid Key Format (must start with sk_)', 'error');
                return;
            }

            try {
                const response = await fetch('/api/verify-stripe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secretKey: sk })
                });
                const result = await response.json();

                if (result.success) {
                    led.className = 'status-led active';
                    led.title = result.message + '\n' + result.details;
                    showToast("Stripe Key is Live: " + result.details, 'success');
                    localStorage.setItem('syriaPay_sk', sk);
                } else {
                    led.className = 'status-led error';
                    led.title = result.message;
                    showToast("Stripe Error: " + result.message, 'error');
                }
            } catch (e) {
                led.className = 'status-led error';
                led.title = "Network Error";
                showToast("Network Error", 'error');
            }
        }

        // === Stripe Elements Logic ===
        let stripeInstance;
        let elements;
        let cardElement;

        // Initialize Stripe Elements when Tab 3 is clicked or PK is changed
        function initStripeElements() {
            const pk = localStorage.getItem('syriaPay_pk');

            if (!pk || !pk.startsWith('pk_')) {
                document.getElementById('stripe-card-element').innerHTML = '<p style="color:red">Please configure a valid Stripe Publishable Key in Settings first.</p>';
                return;
            }

            // If already initialized with same key, return
            if (stripeInstance) return;

            try {
                stripeInstance = Stripe(pk);
                elements = stripeInstance.elements();

                // Customize styling to match dark theme
                const style = {
                    base: {
                        color: '#32325d',
                        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                        fontSmoothing: 'antialiased',
                        fontSize: '16px',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                };

                cardElement = elements.create('card', { style: style });
                cardElement.mount('#stripe-card-element');

                // Handle real-time validation errors from the card Element.
                cardElement.on('change', function (event) {
                    var displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

            } catch (e) {
                console.error("Stripe Init Error:", e);
                document.getElementById('stripe-card-element').innerText = "Error initializing Stripe: " + e.message;
            }
        }

        async function verifyWithStripeElement() {
            let sk = localStorage.getItem('syriaPay_sk');
            const resultDiv = document.getElementById('element-result');

            // Allow fallback to backend environment key
            if (!sk || sk === 'Not Configured') {
                sk = 'Not Configured'; // Backend will handle it
            }

            if (!stripeInstance || !cardElement) {
                initStripeElements();
                if (!cardElement) return;
            }

            resultDiv.innerHTML = '<span style="color: var(--primary)">Processing...</span>';

            try {
                // 1. Get Client Secret from Backend
                const response = await fetch('/api/stripe/create-setup-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sk: sk })
                });

                const data = await response.json();

                if (!data.success) {
                    resultDiv.innerHTML = '<span style="color: var(--danger)">Backend Error: ' + data.message + '</span>';
                    return;
                }

                const clientSecret = data.clientSecret;

                // 2. Confirm Setup with Stripe.js
                const result = await stripeInstance.confirmCardSetup(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            name: 'SyriaPay Test User',
                        },
                    },
                });

                if (result.error) {
                    // Show error to your customer (e.g., insufficient funds)
                    resultDiv.innerHTML = '<span style="color: var(--danger)">DECLINED: ' + result.error.message + '</span>';
                    showToast("Card Declined/Invalid", "error");
                } else {
                    // The setup has succeeded.
                    if (result.setupIntent.status === 'succeeded') {
                        resultDiv.innerHTML = '<span style="color: var(--success)">LIVE / APPROVED! SetupIntent Succeeded.</span>';
                        showToast("Card is LIVE!", "success");
                    } else {
                        resultDiv.innerHTML = '<span style="color: #f9a021">Status: ' + result.setupIntent.status + '</span>';
                    }
                }

            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = '<span style="color: var(--danger)">Error: ' + error.message + '</span>';
            }
        }

        // Add listener to tab switch to init elements
        const originalSwitchTab = switchTab;
        switchTab = function (tabId) {
            originalSwitchTab(tabId);
            if (tabId === 'tab3') {
                setTimeout(initStripeElements, 500); // Small delay to ensure DOM is visible
            }
        };

        // === Bulk Subscription Logic ===
        async function startSubscriptionCheck() {
            const checkInput = document.getElementById('checkInput').value.trim();
            const logDiv = document.getElementById('checkLog');
            let sk = localStorage.getItem('syriaPay_sk');
            const priceId = document.getElementById('priceIdInput').value.trim();

            // Allow fallback to backend environment key
            if (!sk || sk === 'Not Configured') {
                sk = 'Not Configured'; // Backend will handle it
            }

            if (!checkInput) {
                alert("Please paste a list of cards to subscribe.");
                return;
            }

            const lines = checkInput.split('\n').filter(l => l.trim() !== '');
            logDiv.innerHTML = `<div style="color:var(--primary)">Processing ${lines.length} cards for Subscription...</div>`;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                // Parse card details (assumes format: number|month|year|cvv)
                const parts = line.split('|');

                if (parts.length < 3) {
                    logDiv.innerHTML += `<div class="log-entry" style="color:#666">Invalid Format: ${line}</div>`;
                    continue;
                }

                const cardData = {
                    number: parts[0].trim(),
                    exp_month: parts[1].trim(),
                    exp_year: parts[2].trim().length === 2 ? '20' + parts[2].trim() : parts[2].trim(),
                    cvc: parts[3] ? parts[3].trim() : '123' // Default CVC if missing
                };

                // Add loading indicator for this line
                const logId = 'log-sub-' + i;
                logDiv.innerHTML += `<div id="${logId}" class="log-entry">Processing: ${cardData.number}...</div>`;
                logDiv.scrollTop = logDiv.scrollHeight;

                try {
                    const response = await fetch('/api/stripe/subscribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sk: sk,
                            card: cardData,
                            priceId: priceId
                        })
                    });

                    const res = await response.json();
                    const entry = document.getElementById(logId);

                    if (res.success) {
                        let msg = `<span style="color:var(--success)">[SUCCESS]</span> ${cardData.number} -> Cust: ${res.customer}`;
                        if (res.subscription) {
                            msg += ` | Sub: ${res.subscription} (${res.status})`;
                        } else {
                            msg += ` | No Sub (Customer Created)`;
                        }
                        entry.innerHTML = msg;
                    } else {
                        let color = 'var(--danger)';
                        if (res.code === 'card_declined') color = '#f87171';
                        entry.innerHTML = `<span style="color:${color}">[FAILED]</span> ${cardData.number} -> ${res.message}`;
                    }

                } catch (e) {
                    document.getElementById(logId).innerHTML = `<span style="color:var(--danger)">[ERROR]</span> ${cardData.number} -> ${e.message}`;
                }

                // Small delay to prevent rate limits
                await new Promise(r => setTimeout(r, 500));
            }

            logDiv.innerHTML += `<div style="color:var(--primary); margin-top:10px;">=== Batch Finished ===</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function verifyGenericKey(type) {
            const inputId = type === 'paypal' ? 'paypalInput' : 'mastercardInput';
            const ledId = type === 'paypal' ? 'led-paypal' : 'led-mastercard';

            const val = document.getElementById(inputId).value.trim();
            const led = document.getElementById(ledId);

            // Mock Validation Logic
            if (val.length > 10) {
                led.className = 'status-led active';
                led.title = 'Key Format Valid (Mock)';
            } else {
                led.className = 'status-led error';
                led.title = 'Invalid Length';
            }
        }

        // === Logic: Luhn Generator ===
        let generatedCardsList = [];
        let activeCardsList = [];

        function luhnCheckDigit(payload) {
            let digits = payload.split('').map(Number).reverse();
            let sum = 0;

            for (let i = 0; i < digits.length; i++) {
                let digit = digits[i];
                if (i % 2 === 0) { // Double every 2nd digit from right (in final number, this corresponds to even indices in reversed payload)
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
            }

            return (sum * 9) % 10;
        }

        function generateCards() {
            const rawBin = document.getElementById('binInput').value;
            let bin = rawBin.replace(/\s+/g, '').trim(); // Remove spaces for logic
            const qty = parseInt(document.getElementById('qtyInput').value);
            const outputDiv = document.getElementById('genOutputFormatted');

            // Custom Inputs
            const selMonth = document.getElementById('monthInput').value;
            const selYear = document.getElementById('yearInput').value;
            const customCvv = document.getElementById('cvvInput').value.trim();

            // Allow 16 digits but process them
            if (!/^\d{6,16}$/.test(bin)) {
                alert(translations[currentLang].msg_invalid_bin);
                return;
            }

            // Smart Truncation Logic
            // If user provides full card (16) or near full (15) and wants multiple cards,
            // we assume they want variations, so we cut back to 14 digits to allow the 15th to vary.
            if (qty > 1) {
                if (bin.length >= 15) {
                    bin = bin.substring(0, 14);
                }
            } else {
                // If qty is 1, we just ensure we have room for the checksum
                if (bin.length === 16) {
                    bin = bin.substring(0, 15);
                }
            }

            generatedCardsList = [];
            outputDiv.innerHTML = "";
            document.getElementById('selectionControls').style.display = 'flex';
            document.getElementById('selectAllBox').checked = false;

            for (let i = 0; i < qty; i++) {
                // Target length 16. Payload length 15.
                // Random digits needed = 15 - bin.length
                let randomPart = "";
                let needed = 15 - bin.length;
                if (needed < 0) needed = 0;

                for (let j = 0; j < needed; j++) {
                    randomPart += Math.floor(Math.random() * 10);
                }

                let payload = bin + randomPart;
                let checkDigit = luhnCheckDigit(payload);
                let cardNum = payload + checkDigit;

                // Logic: Determine Exp
                let month = (selMonth === "rnd") ? String(Math.floor(Math.random() * 12) + 1).padStart(2, '0') : selMonth;
                let year = (selYear === "rnd") ? (Math.floor(Math.random() * 5) + 26) : selYear;

                // Logic: Determine CVV
                let cvv = customCvv ? customCvv : String(Math.floor(Math.random() * 1000)).padStart(3, '0');

                let line = `${cardNum}|${month}/20${year}|${cvv}`;
                generatedCardsList.push(line);

                // Create formatted entry
                const entry = document.createElement('div');
                entry.style.borderBottom = "1px solid #1f2937";
                entry.style.padding = "8px 0";
                entry.style.display = "flex";
                entry.style.alignItems = "center";

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.className = "card-checkbox";
                checkbox.value = line;

                // Content
                const content = document.createElement('span');
                content.innerHTML = `${line} <span class="luhn-badge" data-i18n="luhn_passed">${translations[currentLang].luhn_passed}</span>`;

                entry.appendChild(checkbox);
                entry.appendChild(content);
                outputDiv.appendChild(entry);
            }
        }

        function toggleSelectAll() {
            const master = document.getElementById('selectAllBox');
            const checkboxes = document.querySelectorAll('.card-checkbox');
            checkboxes.forEach(cb => cb.checked = master.checked);
        }

        function sendSelectedToChecker() {
            const checkboxes = document.querySelectorAll('.card-checkbox:checked');
            if (checkboxes.length === 0) {
                alert(translations[currentLang].msg_select_card);
                return;
            }

            let selectedCards = [];
            checkboxes.forEach(cb => selectedCards.push(cb.value));

            // Switch to Checker Tab
            switchTab('tab3');

            // Populate Input
            const checkInput = document.getElementById('checkInput');
            checkInput.value = selectedCards.join('\n');

            // Highlight Input slightly
            checkInput.focus();
            checkInput.style.borderColor = "var(--primary)";
            setTimeout(() => { checkInput.style.borderColor = "var(--border)"; }, 1000);
        }

        // === Logic: Active Cards Mock ===
        function loadActiveCards() {
            const tbody = document.querySelector('#activeTable tbody');
            tbody.innerHTML = "";

            if (activeCardsList.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align:center; color: var(--text-light); padding: 20px;">${translations[currentLang].msg_no_active}</td>`;
                tbody.appendChild(row);
                return;
            }

            activeCardsList.forEach(cardStr => {
                const parts = cardStr.split('|');
                const row = document.createElement('tr');

                // Status is always Verified Active for this list
                const status = '<span style="color:#10b981; font-weight:bold">Active (Verified 100%)</span>';

                row.innerHTML = `
                <td>${parts[0]}</td>
                <td>${parts[1]}</td>
                <td>${parts[2]}</td>
                <td>${status}</td>
            `;
                tbody.appendChild(row);
            });
        }

        function copyActiveCards() {
            if (activeCardsList.length === 0) {
                alert(translations[currentLang].msg_no_active);
                return;
            }
            const text = activeCardsList.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                showToast(translations[currentLang].msg_copied, 'success');
            }).catch(err => {
                showToast('Failed to copy', 'error');
            });
        }

        function downloadActiveCards() {
            if (activeCardsList.length === 0) {
                alert(translations[currentLang].msg_no_active);
                return;
            }
            const text = activeCardsList.join('\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Live_Cards_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
            showToast(translations[currentLang].msg_downloaded, 'success');
        }

        // === Logic: Checker (Real Stripe API) ===
        async function startChecker() {
            const input = document.getElementById('checkInput').value.trim();
            const log = document.getElementById('checkLog');
            const secretKey = localStorage.getItem('syriaPay_sk');
            const publishableKey = localStorage.getItem('syriaPay_pk');

            log.innerHTML = "";

            // Check Internet Connection
            if (!navigator.onLine) {
                log.innerHTML = `<span class="log-die" style="font-size:1.1em; display:block; padding:10px; border:1px solid var(--danger);">⚠ Error: No Internet Connection.<br>Checking cards requires an active internet connection to contact Stripe.</span>`;
                return;
            }

            if (!secretKey || !secretKey.startsWith('sk_')) {
                log.innerHTML = `<span class="log-die">Error: Missing or Invalid Secret Key. Please go to Settings and enter a valid sk_live_... key.</span>`;
                return;
            }
            if (!publishableKey || !publishableKey.startsWith('pk_')) {
                log.innerHTML = `<span class="log-die">Error: Missing or Invalid Publishable Key. Please go to Settings and enter a valid pk_live_... key for Tokenization.</span>`;
                return;
            }

            // Initialize Stripe.js with the provided Publishable Key
            const stripe = Stripe(publishableKey);

            let lines = input ? input.split('\n') : generatedCardsList;
            if (lines.length === 0) {
                log.innerHTML = "No cards to check. Please generate cards first or paste a list.";
                return;
            }

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Log checking
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerText = `Tokenizing ${line}...`;
                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;

                // Parse Card Details
                const parts = line.split('|');
                if (parts.length < 3) {
                    entry.innerHTML = `<span class="log-die">[INVALID FORMAT]</span> ${line}`;
                    continue;
                }

                const cardNumber = parts[0].trim();
                const expRaw = parts[1].trim();
                const cvv = parts[2] ? parts[2].trim() : "";

                let expMonth, expYear;
                if (expRaw.includes('/')) {
                    const expParts = expRaw.split('/');
                    expMonth = expParts[0].trim();
                    expYear = expParts[1] ? expParts[1].trim() : "";
                } else {
                    entry.innerHTML = `<span class="log-die">[INVALID DATE FORMAT]</span> ${line}`;
                    continue;
                }

                if (!expYear || !expMonth) {
                    entry.innerHTML = `<span class="log-die">[INVALID DATE]</span> ${line}`;
                    continue;
                }

                if (expYear.length === 2) expYear = "20" + expYear;

                // Robust Tokenization Chain
                let payload = { secretKey };
                let tokenizationSuccess = false;
                let errorMessage = "";

                // Attempt 1: createPaymentMethod (Modern)
                try {
                    const pmResult = await stripe.createPaymentMethod({
                        type: 'card',
                        card: { number: cardNumber, exp_month: expMonth, exp_year: expYear, cvc: cvv },
                    });
                    if (pmResult.paymentMethod) {
                        payload.paymentMethodId = pmResult.paymentMethod.id;
                        entry.innerText = `Checking ${cardNumber} (Via PM)...`;
                        tokenizationSuccess = true;
                    } else {
                        errorMessage = pmResult.error.message;
                    }
                } catch (e) {
                    errorMessage = e.message;
                }

                // Attempt 2: createToken (Legacy JS) - Only if PM failed
                if (!tokenizationSuccess) {
                    try {
                        // Note: createToken('card') might throw "Invalid value for token type" if 'card' isn't supported
                        // by the loaded Stripe.js version/config without Elements. We catch this to fallback.
                        const tokenResult = await stripe.createToken('card', {
                            number: cardNumber, exp_month: expMonth, exp_year: expYear, cvc: cvv
                        });

                        if (tokenResult.token) {
                            payload.token = tokenResult.token.id;
                            entry.innerText = `Checking ${cardNumber} (Via Token)...`;
                            tokenizationSuccess = true;
                        } else {
                            errorMessage = tokenResult.error.message;
                        }
                    } catch (e) {
                        errorMessage = e.message; // Capture the "Invalid value..." error
                    }
                }

                // Attempt 3: Direct API Call (Last Resort) - If JS SDK fails
                if (!tokenizationSuccess) {
                    try {
                        const body = new URLSearchParams();
                        body.append('card[number]', cardNumber);
                        body.append('card[exp_month]', expMonth);
                        body.append('card[exp_year]', expYear);
                        body.append('card[cvc]', cvv);

                        const directResp = await fetch('https://api.stripe.com/v1/tokens', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + publishableKey,
                                'Content-Type': 'application/x-www-form-urlencoded'
                            },
                            body: body
                        });

                        const directData = await directResp.json();

                        if (directData.id) {
                            payload.token = directData.id;
                            entry.innerText = `Checking ${cardNumber} (Via Direct API)...`;
                            tokenizationSuccess = true;
                        } else {
                            errorMessage = directData.error ? directData.error.message : "Unknown API Error";
                        }
                    } catch (directErr) {
                        errorMessage = "Direct API Network Error: " + directErr.message;
                    }
                }

                // If all attempts failed
                if (!tokenizationSuccess) {
                    // Enhance error message for common issues
                    if (errorMessage.includes('Invalid value for token type') || errorMessage.includes('You specified: card')) {
                        errorMessage = `<span style="color:#ef4444; font-weight:bold;">Restricted Key Error:</span> This Publishable Key is not allowed to send raw card numbers. <br><span style="color:#aaa; font-size:0.9em;">(Stripe requires 'Handle Card Data Directly' permission for this. Use a key with permissions or use Stripe Elements.)</span>`;
                    } else if (errorMessage.includes('Stripe Elements')) {
                        errorMessage += ` <br><span style="color:#aaa; font-size:0.8em;">(This key requires Stripe Elements or Direct API access)</span>`;
                    }
                    entry.innerHTML = `<span class="log-die">[TOKEN_ERROR]</span> ${line} - ${errorMessage}`;
                    continue;
                }

                try {
                    // 2. Send ID to Backend
                    const response = await fetch('/api/check-card', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (data.live) {
                        entry.innerHTML = `<span class="log-live">[LIVE]</span> ${line} - ${data.message}`;
                        if (!activeCardsList.includes(line)) {
                            activeCardsList.push(line);
                        }
                    } else {
                        // Distinguish errors
                        if (data.code === 'incorrect_number' || data.code === 'invalid_number') {
                            entry.innerHTML = `<span class="log-die" style="color:var(--text-light); border-color:var(--text-light);">[INVALID]</span> ${line} - Card Number Not Exist`;
                        } else if (data.code === 'card_declined') {
                            entry.innerHTML = `<span class="log-die">[DECLINED]</span> ${line} - ${data.message}`;
                        } else {
                            entry.innerHTML = `<span class="log-die">[DIE]</span> ${line} - ${data.message}`;
                        }
                    }
                } catch (err) {
                    entry.innerHTML = `<span class="log-die">[ERROR]</span> ${line} - Backend Connection Failed: ${err.message}`;
                }

                // Rate Limit Delay
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    </script>

</body>

</html>